
steps:
- id: Terraform
  name: 'hashicorp/terraform:0.12.26'
  entrypoint: 'sh'
  args: 
  - '-c'
  - | 
      cd prod/
      terraform init
      terraform validate || exit 1
      terraform apply --auto-approve \
                      -replace="module.slurm_cluster_controller.google_compute_instance.controller_node[0]" \
                      -replace="module.slurm_cluster_login.google_compute_instance.login_node[0]" || exit 1

      #- id: Cluster-services update
      #  name: 'gcr.io/cloud-builders/gcloud'
      #  entrypoint: '/bin/sh'
      #  args: 
      #  - '-c'
      #  - | 
      #      ssh-keygen -b 2048 -t rsa -f /tmp/sshkey -q -N ""
      #
      #      gcloud compute ssh ${_CONTROLLER} \
      #         --zone=${_ZONE} \
      #         --ssh-key-file=/tmp/sshkey \
      #         --command="sudo -i cluster-services update config"
      #
      #      gcloud compute ssh ${_CONTROLLER} \
      #         --zone=${_ZONE} \
      #         --ssh-key-file=/tmp/sshkey \
      #         --command="sudo -i cluster-services update all"

      #substitutions:
      #  _CONTROLLER: 'slurm-controller'
      #  _ZONE: 'us-west1-b'

